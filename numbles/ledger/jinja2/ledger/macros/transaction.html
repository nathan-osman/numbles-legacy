{% import 'ledger/macros/util.html' as util %}
{% import 'macros/ui.html' as ui %}

{##
 # Display table header.
 #   fields - list of fields to display
 #   request - enable sorting
 #}
{% macro _header(fields, request) %}
    <tr>
        {% for f in fields %}
            {% if f == 'reconciled' %}
                <th class="text-center">
            {% elif f in ('date', 'account', 'summary') %}
                <th>
            {% elif f in ('amount', 'balance') %}
                <th class="text-right">
            {% endif %}
            {% if request is not none %}
                <a href="{{ request.path }}?{{ qs(request, sort=f) }}">
            {% endif %}
            {% if f == 'date' %}
                Date / Time
            {% elif f == 'account' %}
                Account
            {% elif f == 'summary' %}
                Summary
            {% elif f == 'reconciled' %}
                Reconciled?
            {% elif f == 'amount' %}
                Amount
            {% elif f == 'balance' %}
                Balance
            {% endif %}
            {% if request is not none %}
                {% if f == request.GET.get('sort', '') %}
                    <span class="fa fa-sort"></span>
                {% endif %}
                </a>
            {% endif %}
            </th>
        {% endfor %}
    </tr>
{% endmacro %}

{##
 # Display balance forward row.
 #   fields - list of fields to display
 #   balance - starting balance
 #}
{% macro _balance(fields, balance) %}
    <tr>
        {% for f in fields %}
            {% if loop.first %}
                <td>Balance Forward</td>
            {% elif f == 'balance' %}
                <td class="text-right">
                    {{ util.currency(balance) }}
                </td>
            {% else %}
                <td></td>
            {% endif %}
        {% endfor %}
    </tr>
{% endmacro %}

{##
 # Display table data.
 #   fields - list of fields to display
 #   transactions - list or QuerySet of transactions
 #   balance - starting balance
 #}
{% macro _data(fields, transactions, balance) %}
    {% set accumulator = [balance or 0] %}
    {% for t in transactions %}
        <tr>
            {% for f in fields %}
                {% if f == 'date' %}
                    <td class="text-nowrap">
                        {{ localtime(t.date) }}
                    </td>
                {% elif f == 'account' %}
                    <td>
                        <a href="{{ t.account.get_absolute_url() }}">
                            {{ t.account }}
                        </a>
                    </td>
                {% elif f == 'summary' %}
                    <td>
                        <a href="{{ t.get_absolute_url() }}">
                            {{ t.summary }}
                        </a>
                    </td>
                {% elif f == 'reconciled' %}
                    <td class="text-center">
                        {% if t.reconciled %}
                            <span class="fa fa-check text-success"></span>
                        {% else %}
                            <span class="fa fa-times text-danger"></span>
                        {% endif %}
                    </td>
                {% elif f == 'amount' %}
                    <td class="text-right">{{ util.currency(t.amount) }}</td>
                {% elif f == 'balance' %}
                    {# Workaround to accumulate a value #}
                    {% if accumulator.append(accumulator.pop() + t.amount) %}{% endif %}
                    <td class="text-right">{{ util.currency(accumulator[-1]) }}</td>
                {% endif %}
            {% endfor %}
        </tr>
    {% else %}
        <tr>
            <td colspan="{{ fields|length }}">
                <span class="text-muted">
                    No transactions matched
                </span>
            </td>
        </tr>
    {% endfor %}
{% endmacro %}

{##
 # Default buttons.
 #}
{% set new = ui.button(title='New Transaction', icon='plus', url=url('ledger:new_transaction')) %}

{##
 # Display a list of transactions
 #   transactions - list or QuerySet of transactions
 #   title - text to display in the box header
 #   fields - list of fields to display
 #   buttons - list of buttons to display
 #   balance - starting balance (none to hide balance forward)
 #   request - enable sorting
 #}
{% macro list(transactions, title='Transactions', fields=('date', 'summary', 'reconciled', 'amount', 'balance'), buttons=(new,), balance=none, request=none) %}
    {% call ui.box(title=title, icon='credit-card', buttons=buttons) %}
        <div class="table-responsive">
            <table class="table no-margin">
                <thead>
                    {{ _header(fields, request) }}
                </thead>
                <tbody>
                    {% if balance is not none %}
                        {{ _balance(fields, balance) }}
                    {% endif %}
                    {% set t = transactions %}
                    {% if request is not none %}
                        {% if 'sort' in request.GET %}
                            {% set t = transactions.order_by(request.GET['sort']) %}
                        {% endif %}
                    {% endif %}
                    {{ _data(fields, t, balance) }}
                </tbody>
            </table>
        </div>
    {% endcall %}
{% endmacro %}
